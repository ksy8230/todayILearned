{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/docker/practice/react-nginx-docker/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Today I Learned"}},"markdownRemark":{"id":"54e05852-a32f-58fa-8dc9-74d70ad7760e","excerpt":"도커 이미지 만드는 법을 배웠으니 사이드 프로젝트로 만들고 있는 리액트 어플리케이션을 도커 이미지로 nginx에 배포해 보자! 1. 준비물 확인 리액트 어플리케이션 (create-react-app으로 만들어서 해당 템플릿에  명령어를 통해 정적 서버에 올릴 build…","html":"<p>도커 이미지 만드는 법을 배웠으니 사이드 프로젝트로 만들고 있는 리액트 어플리케이션을 도커 이미지로 nginx에 배포해 보자!</p>\n<h3>1. 준비물 확인</h3>\n<ul>\n<li>리액트 어플리케이션 (create-react-app으로 만들어서 해당 템플릿에 <code class=\"language-text\">npm run build</code> 명령어를 통해 정적 서버에 올릴 build 명령어가 내장되어있다)</li>\n<li>도커 설치 완료</li>\n</ul>\n<h3>2. 도커 파일 작성</h3>\n<p>배포용으로 도커 파일을 하나 더 두고자하여 아래와 같이 도커 파일을 작성했다.<br>\n파일명 : Dockerfile_Production</p>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token comment\"># stage1</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:14.17.5</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package.json .</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build</span>\r\n\r\n<span class=\"token comment\"># stage2</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:alpine</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /app/build /usr/share/nginx/html</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"nginx\"</span>, <span class=\"token string\">\"-g\"</span>, <span class=\"token string\">\"daemon off;\"</span>]</span>\r\n</code></pre></div>\n<p>배포 stage는 총 두 단계이다.<br>\nstage1에서는 리액트 어플리케이션을 빌드하고,<br>\nstage2에서 리액트 build 폴더를 nginx html 폴더에 복사하여 넣어준다. 그리고 nginx 서버 실행!</p>\n<p>내가 만든 도커 환경을 그림으로 표현하면 아래와 같을 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/todayILearned/static/aa3e3ad9278faaafdd77898c71baca7a/15ec7/dockerFileSystem.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.291139240506325%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAduaQhB//8QAGhAAAgIDAAAAAAAAAAAAAAAAABEBAhIhMf/aAAgBAQABBQJaRbuQyT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAADAQEBAAAAAAAAAAAAAAAAAREhMUH/2gAIAQEAAT8hVIVeKGMChSDrw0z/2gAMAwEAAgADAAAAEMAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAMAAwEAAAAAAAAAAAAAAQARITFBYXH/2gAIAQEAAT8QFL3yhKdfQbCEZK6lTpXsJ2iLTif/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"도커\"\n        title=\"도커\"\n        src=\"/todayILearned/static/aa3e3ad9278faaafdd77898c71baca7a/828fb/dockerFileSystem.jpg\"\n        srcset=\"/todayILearned/static/aa3e3ad9278faaafdd77898c71baca7a/ff44c/dockerFileSystem.jpg 158w,\n/todayILearned/static/aa3e3ad9278faaafdd77898c71baca7a/a6688/dockerFileSystem.jpg 315w,\n/todayILearned/static/aa3e3ad9278faaafdd77898c71baca7a/828fb/dockerFileSystem.jpg 630w,\n/todayILearned/static/aa3e3ad9278faaafdd77898c71baca7a/15ec7/dockerFileSystem.jpg 690w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h4>stage 1 설명</h4>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> node:14.17.5 <span class=\"token keyword\">as</span> builder</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">WORKDIR</span> /app</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> package.json .</span></code></pre></div>\n<p>리액트 어플리케이션이 실행되기 위해선 node 환경이 필요하므로 내 로컬 환경 버전과 동일한 노드 버전을 도커 호스트에 설치했다.<br>\n호스트에 /app 경로를 만들어 그곳에 package.json을 복사했다.</p>\n<ul>\n<li>package.json을 먼저 복사한 이유\n<ul>\n<li>도커 이미지는 각 명령어마다 레이어층을 만든다. 그렇기 때문에 도커 이미지를 만들 때, 해당하는 명령어 레이어에 변화가 없다면 캐싱 기능을 사용할 수 있다!</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm install</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> . .</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">RUN</span> npm run build</span></code></pre></div>\n<p>package.json에 수정사항이 있다면 npm install로 노드모듈들을 재설치 후 로컬에 있는 모든 파일을 호스트의 /app 폴더에 전부 카피한다. 그리고 여기서\r\n<strong><code class=\"language-text\">.dockerignore</code> 파일에 반드시 <code class=\"language-text\">node_modules</code>를 기재해야 전체 파일 카피할 때 시간을 절약</strong>할 수 있다.</p>\n<h4>stage 2 설명</h4>\n<div class=\"gatsby-highlight\" data-language=\"dockerfile\"><pre class=\"language-dockerfile\"><code class=\"language-dockerfile\"><span class=\"token instruction\"><span class=\"token keyword\">FROM</span> nginx:alpine</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> nginx.conf /etc/nginx/conf.d/default.conf</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">COPY</span> <span class=\"token options\"><span class=\"token property\">--from</span><span class=\"token punctuation\">=</span><span class=\"token string\">builder</span></span> /app/build /usr/share/nginx/html</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">EXPOSE</span> 80</span>\r\n<span class=\"token instruction\"><span class=\"token keyword\">CMD</span> [<span class=\"token string\">\"nginx\"</span>, <span class=\"token string\">\"-g\"</span>, <span class=\"token string\">\"daemon off;\"</span>]</span></code></pre></div>\n<p>도커 허브에서 nginx 이미지를 가져온다.\r\n<strong>로컬에 있는 nginx 설정 파일을 호스트의 nginx 설치 디렉터리에 복사</strong>한다.<br>\nstage1에서 빌드한 파일들을 호스트의 nginx 공용 디렉터리에 복사한다.<br>\n도커 컨테이너 내부에서 실행되는 포트는 80을 노출시킨다.<br>\n컨테이너가 시작될 때 서버를 실행한다.</p>\n<p>COPY nginx.conf /etc/nginx/conf.d/default.conf 해당 부분을 넣어주지 않고 nginx 서버에 빌드 파일을 배포하면 리액트의 라우팅 관련한 문제가 생긴다…<br>\n이러한 이유는 리액트가 싱글페이지어플리케이션으로 동작하기 때문이다.<br>\nurl이 마치 이동을 하는 것 같지만 실제로 한 화면 안에서 다른 태그들을 불러와주는 식으로 이루어져 있기 때문에 <a href=\"http://www.host.co.kr/index\">www.host.co.kr/index</a> 에서 <a href=\"http://www.host.co.kr/2\">www.host.co.kr/2</a> 로 넘어갈 때 해당 주소는 실제로 존재하지 않는다.<br>\n때문에 nginx에서 없는 주소인 경우 root로 돌아가게끔 설정시켜줘야 한다. 없는 주소를 입력 시 root로 돌아가고, root를 기준으로 어플리케이션이 라우팅을 하게 만들어줌으로써 페이지 이동 구현이 정상 작동한다.</p>\n<h3>도커 파일 실행</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">> docker build -t awesome-app:nginx -f Dockerfile_Production .;\r\n> docker rm --force (빌드된 이미지 이름);\r\n> docker run -p 8081:80 awesome-app:nginx;</code></pre></div>\n<h3>출처</h3>\n<ul>\n<li><a href=\"https://www.youtube.com/watch?v=gM2cWo1DWIk\">리액트앱을 nginx에 도커로 배포</a></li>\n<li><a href=\"https://medium.com/greedygame-engineering/so-you-want-to-dockerize-your-react-app-64fbbb74c217\">nginx에서 리액트앱 라우터 문제 해결</a></li>\n</ul>","frontmatter":{"title":"리액트 어플리케이션을 nginx 정적 서버에 배포하는 도커 이미지 만들기","date":"2022-01-12","description":null,"tags":["docker"]}},"previous":{"fields":{"slug":"/docker/docker3/"},"frontmatter":{"title":"생활코딩 Docker 이미지 만드는 법"}},"next":{"fields":{"slug":"/project/work/gitlab_cicd/"},"frontmatter":{"title":"깃랩 cicd"}}},"pageContext":{"id":"54e05852-a32f-58fa-8dc9-74d70ad7760e","previousPostId":"c70e72a4-a4a6-51a6-b6a2-1f86e0702c43","nextPostId":"3e4721bf-e1b6-53ef-90e0-cc68c89716af"}},
    "staticQueryHashes": ["2841359383","3708219967"]}